<odoo>
  <record id="view_verifactu_settings" model="ir.ui.view">
    <field name="name">res.config.settings.verifactu</field>
    <field name="model">res.config.settings</field>
    <field name="inherit_id" ref="base.res_config_settings_view_form"/>
    <field name="arch" type="xml">
      <xpath expr="//div[hasclass('settings')]" position="inside">
            <field name="company_id" invisible="1"/>
            
        <div class="app_settings_block"
             data-string="Veri*Factu"
             string="Veri*Factu"
             data-key="l10n_es_verifactu">
          
          <!-- Nueva secci√≥n: Selecci√≥n de modo -->
      <h2>Modo de Operaci√≥n</h2>
      <div class="row mt16 o_settings_container">
        <!-- üëá este box ahora ocupa todo el ancho en escritorio -->
        <div class="col-12 col-lg-12 o_setting_box">
          <div class="o_setting_left_pane"/>
          <div class="o_setting_right_pane">

            <div class="text-muted content-group mb8">
              Selecciona si el sistema funcionar√° en <strong>modo VeriFactu</strong> (env√≠o autom√°tico a la AEAT)
              o en <strong>modo No VeriFactu</strong> (remisi√≥n bajo requerimiento).
            </div>

            <div class="mb16">
              <field name="verifactu_mode_enabled"
                    widget="boolean"
                    class="oe_inline"
                    help="Activa el modo VeriFactu (env√≠o autom√°tico a la AEAT). 
                          Si est√° activo, no puede activarse el modo No VeriFactu."/>
              <label for="verifactu_mode_enabled" string="Modo VeriFactu" class="o_form_label"/>
            </div>

            <div class="mb16">
              <field name="no_verifactu_mode_enabled"
                    widget="boolean"
                    class="oe_inline"
                    help="Activa el modo No VeriFactu (remisi√≥n bajo requerimiento). 
                          Si est√° activo, no puede activarse el modo VeriFactu."/>
              <label for="no_verifactu_mode_enabled" string="Modo No VeriFactu" class="o_form_label"/>
            </div>

            <div class="text-warning mb16"
                attrs="{'invisible':[('verifactu_mode_enabled','=',False)]}">
              ‚ö†Ô∏è Una vez activado el modo VeriFactu, no puedes volver al modo No VeriFactu hasta transcurrido un a√±o.
            </div>

            <div class="text-muted mt16">
              <p><strong>Registro de cambios:</strong></p>
              <ul style="list-style:none;padding-left:0;">
                <li><strong>√öltimo modo activo:</strong> 
                  <field name="last_verifactu_mode" readonly="1" nolabel="1"/>
                </li>
                <li><strong>Fecha de activaci√≥n:</strong> 
                  <field name="verifactu_mode_activation_date" readonly="1" nolabel="1"/>
                </li>
              </ul>
            </div>

            <div class="text-muted" style="font-style:italic;margin-top:5px;">
              Solo uno de los dos modos puede estar activo a la vez.
            </div>

          

          </div>
        </div>
      </div>

       <h2>Hist√≥rico de modos</h2>


          <!-- =================== Hist√≥rico de modos  =================== -->
         
          <div class="row mt16 o_settings_container">
            <div class="col-12 col-lg-6 o_setting_box">
              <div class="o_setting_left_pane"/>
              <div class="o_setting_right_pane">

                <div class="mb16">
                  <span class="o_form_label">Hist√≥rico</span>
                  <div class="text-muted content-group">
                         Consulta todos los cambios entre <strong>VeriFactu</strong> y <strong>No VeriFactu</strong>
                 (fecha, usuario y notas) en una vista completa.
                  </div>
                 <button name="action_open_verifactu_history"
                        type="object"
                        string="Ver completo"
                        class="btn btn-light btn-sm"
                        icon="fa-external-link"/>
                </div>

                
              </div>
            </div>
          </div>

          <h2>Configuraci√≥n del m√≥dulo Veri*Factu</h2>

          <!-- Configuraci√≥n general -->
          <div class="row mt16 o_settings_container">
            <div class="col-12 col-lg-6 o_setting_box">
              <div class="o_setting_left_pane"/>
              <div class="o_setting_right_pane">

                <div class="mb16">
                  <span class="o_form_label">Endpoint del servicio</span>
                  <div class="text-muted content-group">
                    URL del servicio SOAP de la AEAT (producci√≥n o pruebas).
                  </div>
                  <field name="endpoint_url" placeholder="https://prewww1.aeat.es/wlpl/TIKE-CONT/ws/SistemaFacturacion/VerifactuSOAP"/>
                </div>

                <div class="mb16">
                  <span class="o_form_label">Mostrar QR siempre</span>
                  <div class="text-muted content-group">
                    Si est√° activado, el QR se mostrar√° aunque no se haya enviado la factura.
                  </div>
                  <field name="show_qr_always"/>
                </div>

                <div class="mb16">
                  <span class="o_form_label">Env√≠o autom√°tico a Veri*Factu</span>
                  <div class="text-muted content-group">
                    Activa esta opci√≥n para enviar autom√°ticamente las facturas emitidas al validar.
                  </div>
                  <field name="auto_send_to_verifactu"/>
                </div>

              </div>
            </div>
          </div>

          <!-- Entornos AEAT -->
          <h2>Entornos AEAT</h2>
          <div class="row mt16 o_settings_container">
            <div class="col-12 col-lg-8 o_setting_box">
              <div class="o_setting_left_pane"/>
              <div class="o_setting_right_pane">

                <div class="text-muted content-group mb16" style="background-color:#f5f5f5;padding:12px;border-radius:6px;">
                  <p><strong>üîó Modo VeriFactu</strong></p>
                  <p><strong>Producci√≥n:</strong> https://www1.agenciatributaria.gob.es/wlpl/TIKE-CONT/ws/SistemaFacturacion/VerifactuSOAP</p>
                  <p><strong>Pruebas:</strong> https://prewww1.aeat.es/wlpl/TIKE-CONT/ws/SistemaFacturacion/VerifactuSOAP</p>
                </div>

                <div class="text-muted content-group mb16" style="background-color:#f5f5f5;padding:12px;border-radius:6px;">
                  <p><strong>üìÑ Modo NO VeriFactu (Remisi√≥n bajo requerimiento)</strong></p>
                  <p><strong>Producci√≥n:</strong> https://www1.agenciatributaria.gob.es/wlpl/TIKE-CONT/ws/SistemaFacturacion/RequerimientoSOAP</p>
                  <p><strong>Pruebas:</strong> https://prewww1.aeat.es/wlpl/TIKE-CONT/ws/SistemaFacturacion/RequerimientoSOAP</p>
                </div>

              </div>
            </div>
          </div>

            <!-- Automatizaciones -->
            <h2>Automatizaciones</h2>

            <div class="row mt16 o_settings_container">
            <div class="col-12 col-lg-8 o_setting_box">
                <div class="o_setting_left_pane"/>
                <div class="o_setting_right_pane">

                <!-- CRON peri√≥dico -->
                <div class="mb16">
                    <span class="o_form_label">Automatizaci√≥n peri√≥dica</span>
                    <div class="text-muted content-group">
                    Enviar autom√°ticamente las facturas a Veri*Factu cada cierto tiempo mediante un CRON.
                    </div>
                    <field name="cron_auto_send_enabled"/>
                </div>

                <div class="mb16" attrs="{'invisible':[('cron_auto_send_enabled','=',False)]}">
                    <span class="o_form_label">Par√°metros del CRON (peri√≥dico)</span>
                    <div class="text-muted content-group">
                    Ajusta el ritmo y la estrategia de reintentos del env√≠o autom√°tico.<br/>
                    ‚Ä¢ <i>Tama√±o de lote</i>: n¬∫ m√°ximo de facturas por ejecuci√≥n.<br/>
                    ‚Ä¢ <i>Backoff</i>: espera exponencial entre reintentos (con tope).<br/>
                    ‚Ä¢ <i>Intervalo m√≠nimo</i>: margen entre peticiones al portal (rate-limit) por compa√±√≠a.
                    </div>

                    <div class="row">
                    <div class="col-6">
                        <span class="o_form_label">Tama√±o de lote</span>
                        <field name="cron_batch_size" class="oe_inline" placeholder="5"/>
                    </div>
                    <div class="col-6">
                        <span class="o_form_label">Intervalo m√≠nimo (seg)</span>
                        <field name="request_min_interval_sec" class="oe_inline" placeholder="60"/>
                    </div>
                    </div>

                    <div class="row mt8">
                    <div class="col-6">
                        <span class="o_form_label">Backoff base (min)</span>
                        <field name="retry_backoff_min" class="oe_inline" placeholder="10"/>
                    </div>
                    <div class="col-6">
                        <span class="o_form_label">Backoff tope (min)</span>
                        <field name="retry_backoff_cap_min" class="oe_inline" placeholder="60"/>
                    </div>
                    </div>
                </div>

                <div class="text-muted mt8">
                    * El planificador (ir.cron) peri√≥dico se activa cuando marcas esta opci√≥n.
                </div>

                <!-- Env√≠o diario a una hora fija -->
                <div class="mb16 mt24">
                    <span class="o_form_label">Env√≠o diario a una hora</span>
                    <div class="text-muted content-group">
                    Programa un env√≠o autom√°tico de facturas a una hora concreta (hora local de la compa√±√≠a).
                    </div>
                    <field name="daily_auto_send_enabled"/>
                </div>

                <div class="mb16" attrs="{'invisible': [('daily_auto_send_enabled','=',False)]}">
                    <span class="o_form_label">Hora diaria (HH:MM)</span>
                    <div class="text-muted content-group">
                    Introduce la hora en formato 24h. Ej.: <code>03:00</code> o <code>14:30</code>.
                    </div>
                    <field name="daily_send_time" class="oe_inline" placeholder="03:00"/>
                </div>

                <!-- Toggle para par√°metros propios del cron diario -->
                <div class="mb16" attrs="{'invisible': [('daily_auto_send_enabled','=',False)]}">
                    <span class="o_form_label">Par√°metros del cron diario</span>
                    <div class="text-muted content-group">
                    Por defecto el cron diario reutiliza los par√°metros del cron peri√≥dico.<br/>
                    Activa esta opci√≥n si quieres configurar par√°metros distintos para el env√≠o diario.
                    </div>
                    <field name="daily_use_custom_params"/>
                </div>

                <!-- Par√°metros custom del diario -->
                <div class="mb16"
                    attrs="{'invisible': ['|',('daily_auto_send_enabled','=',False),('daily_use_custom_params','=',False)]}">
                    <div class="row">
                    <div class="col-6">
                        <span class="o_form_label">Tama√±o de lote (diario)</span>
                        <field name="daily_cron_batch_size" class="oe_inline" placeholder="5"/>
                    </div>
                    <div class="col-6">
                        <span class="o_form_label">Intervalo m√≠nimo (seg, diario)</span>
                        <field name="daily_request_min_interval_sec" class="oe_inline" placeholder="60"/>
                    </div>
                    </div>

                    <div class="row mt8">
                    <div class="col-6">
                        <span class="o_form_label">Backoff base (min, diario)</span>
                        <field name="daily_retry_backoff_min" class="oe_inline" placeholder="10"/>
                    </div>
                    <div class="col-6">
                        <span class="o_form_label">Backoff tope (min, diario)</span>
                        <field name="daily_retry_backoff_cap_min" class="oe_inline" placeholder="60"/>
                    </div>
                    </div>

                    <div class="text-muted mt8">
                    * Estos par√°metros solo se aplican al cron diario cuando est√° marcada la opci√≥n
                    <i>Par√°metros del cron diario</i>.
                    </div>
                </div>

                <div class="text-muted mt8">
                    * El planificador (ir.cron) diario se crea desactivado y se activa cuando marcas esta opci√≥n.
                </div>

                </div>
            </div>
            </div>



          <!-- Certificado digital -->
          <h2>Certificado Digital</h2>
          <div class="row mt16 o_settings_container">
            <div class="col-12 col-lg-8 o_setting_box">
              <div class="o_setting_left_pane"/>
              <div class="o_setting_right_pane">

                <div class="text-muted content-group mb8">
                  A√±ade tu certificado en formato PFX junto con su contrase√±a para permitir la firma electr√≥nica de las facturas.
                </div>

                <div class="mb8">
                  <field name="cert_password" password="True" placeholder="Contrase√±a del certificado"/>
                </div>

                <div class="mb8">
                  <field name="cert_pfx" filename="cert_pfx_filename"/>
                </div>

                <div class="mb8">
                  <field name="cert_pfx_filename" readonly="1"/>
                </div>

                <div class="text-success mt8 mb8" attrs="{'invisible':[('cert_pfx','=',False)]}">‚úÖ Certificado cargado correctamente.</div>

                <div class="mt8 d-flex gap-2" attrs="{'invisible':[('cert_pfx','=',False)]}">
                  <button name="action_test_certificate" type="object" string="Probar certificado" class="btn btn-primary"/>
                </div>

              </div>
            </div>
          </div>

          <!-- Licencia y actualizaciones -->
          <h2>Licencia y actualizaciones</h2>
          <div class="row mt16 o_settings_container">
            <div class="col-12 col-lg-8 o_setting_box">
              <div class="o_setting_left_pane"/>
              <div class="o_setting_right_pane">

                <div class="text-muted content-group mb8">
                  Introduce tu <strong>clave de licencia</strong> para obtener un token firmado. El token permite la validaci√≥n <i>offline</i>.
                </div>

                <div class="mb8">
                  <span class="o_form_label">Clave de licencia</span>
                  <field name="verifactu_license_key" placeholder="VF-XXXX-XXXX-XXXX" nolabel="1"/>
                </div>

                <div class="mb8">
                  <span class="o_form_label">Estado</span>
                  <field name="verifactu_license_status" readonly="1" class="oe_inline" nolabel="1"/>
                </div>

                <div class="mb8">
                  <label for="verifactu_license_token_display" class="o_form_label">Token (JWT)</label>
                  <field name="verifactu_license_token_display" readonly="1" nolabel="1"/>
                  <div class="text-muted">Generado autom√°ticamente al validar la licencia. No editable.</div>
                </div>

                <div class="mb8">
                  <span class="o_form_label">Comprobaci√≥n peri√≥dica de actualizaciones</span>
                  <field name="verifactu_updates_cron_enabled" nolabel="1"/>
                </div>

                                <div class="mb8">
                                    <label for="verifactu_update_link" class="o_form_label">Link descarga actualizaciones</label>
                                    <field name="verifactu_update_link" widget="url"/>
                                    <div class="text-muted">
                                        Link para poder descargar una versi√≥n actual del m√≥dulo de Veri*Factu
                                    </div>
                                </div>

                <div class="mt8 d-flex gap-2">
                  <button name="action_issue_license_token" type="object" string="Obtener/Actualizar token" class="btn btn-primary"/>
                  <button name="action_verify_license_now" type="object" string="Verificar ahora" class="btn btn-secondary"/>
                </div>

                <div class="mt16 text-muted">
                  <p class="mb0">
                    La <strong>licencia est√° incluida</strong> con la compra del m√≥dulo; <strong>no hay costes adicionales</strong> ni suscripciones.
                    Para adquirirla, escribe a <a href="mailto:rubikdevodoo@gmail.com">rubikdevodoo@gmail.com</a>.
                  </p>
                </div>

              </div>
            </div>
          </div>

          <!-- Declaraci√≥n Responsable -->
          <h2>Declaraci√≥n Responsable</h2>
          <div class="row mt16 o_settings_container">
            <div class="col-12 col-lg-6 o_setting_box">
              <div class="o_setting_left_pane"></div>
              <div class="o_setting_right_pane">
                <div class="text-muted content-group">
                  Este documento viene precargado con la versi√≥n por defecto del m√≥dulo. Puedes descargarlo o subir una versi√≥n personalizada.
                </div>

                <field name="verifactu_declaracion_file" widget="binary" filename="verifactu_declaracion_filename" class="oe_inline"/>
                <button name="action_download_declaracion" type="object" string="Descargar Declaraci√≥n" class="btn btn-secondary mt8"/>
              </div>
            </div>
          </div>

          <!-- Sistema Inform√°tico -->
          <h2>Sistema Inform√°tico Declarado</h2>
          <div class="row mt16 o_settings_container">
            <div class="col-12 col-lg-8 o_setting_box">
              <div class="o_setting_left_pane"/>
              <div class="o_setting_right_pane">

                <div class="text-muted content-group mb8">
                  Indica los datos del software declarado a la Agencia Tributaria como Sistema Inform√°tico de Facturaci√≥n.
                </div>

                <div class="mb8"><field name="verifactu_system_name" placeholder="Nombre del sistema"/></div>
                <div class="mb8"><field name="verifactu_system_id" placeholder="Identificador del sistema"/></div>
                <div class="mb8"><field name="verifactu_system_version" placeholder="Versi√≥n del sistema"/></div>
                <div class="mb8"><field name="verifactu_system_installation_number" placeholder="N√∫mero de instalaci√≥n"/></div>
                <div class="mt16 mb8"><field name="verifactu_system_use_only_verifactu"/></div>
                <div class="mb8"><field name="verifactu_system_multi_ot"/></div>
                <div class="mb8"><field name="verifactu_system_multiple_ot_indicator"/></div>

              </div>
            </div>
          </div>

          <!-- Detector de anomal√≠as -->
          <h2>Detector de anomal√≠as</h2>

          <div class="row mt16 o_settings_container">
            <div class="col-12 col-lg-6 o_setting_box">
              <div class="o_setting_left_pane"/>
              <div class="o_setting_right_pane">

                <div class="text-muted content-group mb8">
                  Revisi√≥n peri√≥dica de facturas para detectar incidencias t√≠picas (pendientes estancadas,
                  desorden cronol√≥gico, etc.). Si se encuentra algo, podr√°s verlo en la vista completa.
                </div>

                <div class="mb16">
                  <span class="o_form_label">Activar detector global</span>
                  <div class="text-muted content-group">
                    Ejecuta un escaneo por compa√±√≠a mediante un planificador.
                  </div>
                  <field name="vf_anomaly_cron_enabled" class="oe_inline"/>
                </div>

                <div class="mb16" attrs="{'invisible':[('vf_anomaly_cron_enabled','=',False)]}">
                  <span class="o_form_label">D√≠as para marcar ‚Äúpendiente‚Äù</span>
                  <div class="text-muted content-group">
                    Si una factura est√° <i>posted + pending</i> m√°s de este n√∫mero de d√≠as, se registrar√° una anomal√≠a.
                  </div>
                  <field name="vf_anomaly_stale_days" class="oe_inline" placeholder="7"/>
                </div>

                <div class="mt8 d-flex gap-2" attrs="{'invisible':[('vf_anomaly_cron_enabled','=',False)]}">
                  <button name="action_run_anomaly_scan"
                          type="object"
                          string="Escanear ahora"
                          class="btn btn-secondary"/>
                  <button name="action_open_anomalies"
                          type="object"
                          string="Ver completo"
                          class="btn btn-light"
                          icon="fa-external-link"/>
                </div>

              </div>
            </div>
          </div>



                    <!-- Ayuda -->
                     <h2>¬øDudas sobre el m√≥dulo?</h2>
                    <div class="row mt16 o_settings_container">
                        <div class="col-12 col-lg-6 o_setting_box">
                            <div class="o_setting_left_pane"/>
                            <div class="o_setting_right_pane">
                                <div class="text-muted content-group">
                                    Consulta una gu√≠a r√°pida con ejemplos y consejos para configurar correctamente el m√≥dulo.
                                </div>
                                <button name="%(l10n_es_verifactu.verifactu_help_wizard_action)d"
                                        type="action"
                                        string="‚öôÔ∏è Mostrar Ayuda del M√≥dulo"
                                        class="btn btn-warning mt8"
                                        context="{}"/>
                            </div>
                        </div>
                    </div>

          <!-- Copyright -->
          <h2>CopyRight</h2>
          <div class="row mt16 o_settings_container">
            <div class="col-12 col-lg-6 o_setting_box">
              <div class="o_setting_left_pane"/>
              <div class="o_setting_right_pane">
                <div class="text-muted mt16" style="font-size:12px;">
                  M√≥dulo desarrollado por <strong>Juan Ormaechea</strong> ‚Äî Mr. Rubik ¬∑ <i>Versi√≥n licenciada. Redistribuci√≥n prohibida.</i>
                </div>
              </div>
            </div>
          </div>

        </div> 

      </xpath>
    </field>
  </record>
</odoo>
